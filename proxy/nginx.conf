worker_processes 1;

error_log stderr debug;
daemon off;

events {
    worker_connections 200;
}

http {
    include /opt/homebrew/etc/nginx/mime.types;

    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    server {
        listen 127.0.0.1:8080;
        listen [::1]:8080;
        server_name localhost;
        include secrets.conf;

        location / {
            root html;
            index index.html index.htm;
        }

        # ---- Anthropic API ----
        location /anthropic/ {
            # Strip /anthropic/ prefix
            proxy_pass https://api.anthropic.com/;

            # Upstream TLS/SNI + Host
            proxy_ssl_server_name on;
            proxy_set_header Host api.anthropic.com;

            # Don't leak the proxy key upstream
            proxy_set_header Authorization "";

            # Inject real Anthropic key + required version header
            proxy_set_header x-api-key $anthropic_api_key;
            proxy_set_header anthropic-version "2023-06-01";

            # Pass through other useful headers
            proxy_set_header Content-Type $content_type;
        }

        # ---- Brave Search ----
        location /brave/ {

            # Client will call: /brave/res/v1/web/search?q=...
            # Upstream receives: /res/v1/web/search?q=...
            proxy_pass https://api.search.brave.com/;

            proxy_ssl_server_name on;
            proxy_set_header Host api.search.brave.com;

            # Don't leak the proxy key upstream
            proxy_set_header Authorization "";

            proxy_set_header X-Subscription-Token $brave_api_key;
            proxy_set_header Accept $http_accept;
        }

        # Error pages
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root html;
        }
    }
}
